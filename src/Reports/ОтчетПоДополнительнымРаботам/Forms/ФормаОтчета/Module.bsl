
&НаСервере
Процедура СформироватьНаСервере()
ОбъектЗн = РеквизитФормыВЗначение("Отчет");
	Если ЗначениеЗаполнено(ЭтаФорма.Параметры.Документ) Тогда
	Макет = ОбъектЗн.ПолучитьМакет("МакетДляДокумента");
	Иначе
	Макет = ОбъектЗн.ПолучитьМакет("Макет");
	КонецЕсли;

ОблШапка = Макет.ПолучитьОбласть("Шапка");
ОблИсполнитель = Макет.ПолучитьОбласть("Исполнитель");
ОблСтрока = Макет.ПолучитьОбласть("Строка");
ОблИсполнительИтого = Макет.ПолучитьОбласть("ИсполнительИтого");
ОблКонец = Макет.ПолучитьОбласть("Конец");

ОблШапка.Параметры.ДатаНач = Формат(Отчет.Период.ДатаНачала,"ДФ=dd.MM.yyyy");
ОблШапка.Параметры.ДатаКон = Формат(Отчет.Период.ДатаОкончания,"ДФ=dd.MM.yyyy");
ОблШапка.Параметры.Подразделение = Отчет.Подразделение;
ТабДок.Вывести(ОблШапка);

Запрос = Новый Запрос;

Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДополнительныеРаботы.Сотрудник КАК Сотрудник,
	|	ДополнительныеРаботы.ТехОперация КАК ТехОперация,
	|	ДополнительныеРаботы.Количество КАК Количество
	|ИЗ
	|	РегистрСведений.ДополнительныеРаботы КАК ДополнительныеРаботы
	|ГДЕ
	|	ДополнительныеРаботы.Период МЕЖДУ &ДатаНач И &ДатаКон
	|	И ДополнительныеРаботы.Подразделение = &Подразделение"; 
Запрос.УстановитьПараметр("ДатаНач", НачалоМесяца(Отчет.Период.ДатаНачала));
Запрос.УстановитьПараметр("ДатаКон", КонецМесяца(Отчет.Период.ДатаОкончания));
Запрос.УстановитьПараметр("Подразделение", Отчет.Подразделение);
	Если СписокИсполнителей.Количество() > 0 Тогда
	Запрос.Текст = Запрос.Текст + " И ДополнительныеРаботы.Сотрудник В(&СписокИсполнителей)";
	Запрос.УстановитьПараметр("СписокИсполнителей", СписокИсполнителей);	
	КонецЕсли;
Запрос.Текст = Запрос.Текст + " УПОРЯДОЧИТЬ ПО
								|	Сотрудник,ТехОперация
								|ИТОГИ
								|	СУММА(Количество)
								|ПО
								|	Сотрудник,ТехОперация"; 
РезультатЗапроса = Запрос.Выполнить();
ВыборкаСотрудник = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
ВсегоДР = 0;
ВсегоОД = 0;
	Пока ВыборкаСотрудник.Следующий() Цикл
	ИтогоДР = 0;
	ИтогоОД = 0;
	ОблИсполнитель.Параметры.ФИО = СокрЛП(ВыборкаСотрудник.Сотрудник.Наименование);
	ОблИсполнитель.Параметры.Исполнитель = ВыборкаСотрудник.Сотрудник;
	ТабДок.Вывести(ОблИсполнитель);
	ВыборкаТО = ВыборкаСотрудник.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаТО.Следующий() Цикл
		СуммаДР = 0;
		СуммаОД = 0;
		ОблСтрока.Параметры.ТехОперация = ВыборкаТО.ТехОперация;
		Выборка = ВыборкаТО.Выбрать();
			Пока Выборка.Следующий() Цикл
			НормыТО = РегистрыСведений.НормыТО.ПолучитьПоследнее(Отчет.Период.ДатаОкончания,Новый Структура("ТехОперация",ВыборкаТО.ТехОперация));
			Стоимость = Выборка.Количество/НормыТО.Норма*НормыТО.Стоимость*Выборка.Сотрудник.Должность.КоэффициентРазряда;
				Если ВыборкаТО.ТехОперация.ДополнительныеРаботы Тогда
				СуммаДР = СуммаДР + Стоимость;
				ИтогоДР = ИтогоДР + Стоимость;
				ВсегоДР = ВсегоДР + Стоимость;
				Иначе
				СуммаОД = СуммаОД + Стоимость;	
				ИтогоОД = ИтогоОД + Стоимость;
				ВсегоОД = ВсегоОД + Стоимость;
				КонецЕсли; 	
			КонецЦикла;
		ОблСтрока.Параметры.СуммаДР = СуммаДР;
		ОблСтрока.Параметры.СуммаОД = СуммаОД;
		ТабДок.Вывести(ОблСтрока);
		КонецЦикла;
	ОблИсполнительИтого.Параметры.ИтогоДР = ИтогоДР;
	ОблИсполнительИтого.Параметры.ИтогоОД = ИтогоОД;
	ТабДок.Вывести(ОблИсполнительИтого);
	КонецЦикла;
ОблКонец.Параметры.ВсегоДР = ВсегоДР; 
ОблКонец.Параметры.ВсегоОД = ВсегоОД;
	Если ЗначениеЗаполнено(ЭтаФорма.Параметры.Документ) Тогда
	ОблКонец.Параметры.Мастер = ЭтаФорма.Параметры.Документ.Автор;
	ОблКонец.Параметры.НачальникПЭО = ОбщийМодульВызовСервера.ПолучитьСотрудникаПоДолжности("Начальник ПЭО");
	КонецЕсли;
ТабДок.Вывести(ОблКонец);
ТабДок.ФиксацияСверху = 3; 
КонецПроцедуры

&НаКлиенте
Процедура Сформировать(Команда)
	Если ЭтаФорма.ПроверитьЗаполнение() Тогда
	СформироватьНаСервере();
	КонецЕсли; 
КонецПроцедуры

&НаСервере
Процедура НастроитьПараметрыОтчета(Документ)
Отчет.Период.ДатаНачала = НачалоМесяца(Документ.Дата);			
Отчет.Период.ДатаОкончания = КонецМесяца(Документ.Дата);
Отчет.Подразделение = Документ.Подразделение;
СписокИсполнителей.Очистить();
	Для каждого ТЧ Из Документ.ТабличнаяЧасть Цикл
	СписокИсполнителей.Добавить(ТЧ.Исполнитель);	
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Если ЗначениеЗаполнено(ЭтаФорма.Параметры.Документ) Тогда
	НастроитьПараметрыОтчета(ЭтаФорма.Параметры.Документ);		
	Сформировать(Неопределено);   	
	КонецЕсли; 
КонецПроцедуры
