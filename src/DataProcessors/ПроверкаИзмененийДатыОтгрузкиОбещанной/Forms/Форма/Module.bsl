
&НаСервере
Функция ПолучитьДолг(ЗНП,Товар)
Запрос = Новый Запрос;

Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДолгиОстатки.Продукция КАК Продукция,
	|	ДолгиОстатки.КоличествоОстаток КАК КоличествоОстаток
	|ИЗ
	|	РегистрНакопления.Долги.Остатки(&НаДату, ) КАК ДолгиОстатки
	|ГДЕ
	|	ДолгиОстатки.Документ = &Документ
	|	И ДолгиОстатки.Продукция.Товар = &Товар";
Запрос.УстановитьПараметр("НаДату",ТекущаяДата());
Запрос.УстановитьПараметр("Документ",ЗНП);
Запрос.УстановитьПараметр("Товар",Товар);
РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	Возврат(ВыборкаДетальныеЗаписи.КоличествоОстаток);
	КонецЦикла;
	Возврат(0);
КонецФункции

&НаСервере
Процедура ПолучитьДанныеПоИзменениям(ТЧ)
Запрос = Новый Запрос;

Запрос.Текст = 
	"ВЫБРАТЬ
	|	ИзменениеДатыОтгрузкиОбещанной.ДатаОтгрузкиОбещанная КАК ДатаОтгрузкиОбещанная,
	|	ИзменениеДатыОтгрузкиОбещанной.ДатаОтгрузкиНовая КАК ДатаОтгрузкиНовая,
	|	ИзменениеДатыОтгрузкиОбещанной.Период КАК Период
	|ИЗ
	|	РегистрСведений.ИзменениеДатыОтгрузкиОбещанной КАК ИзменениеДатыОтгрузкиОбещанной
	|ГДЕ
	|	ИзменениеДатыОтгрузкиОбещанной.ЗНП = &ЗНП
	|	И ИзменениеДатыОтгрузкиОбещанной.Товар = &Товар
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период";
Запрос.УстановитьПараметр("ЗНП",ТЧ.ЗНП);
Запрос.УстановитьПараметр("Товар",ТЧ.Товар);
РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
флПервая = Ложь;
КоличествоИзменений = 0;
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если Не флПервая Тогда
		ТЧ.ДатаОтгрузкиПервая = ВыборкаДетальныеЗаписи.ДатаОтгрузкиОбещанная;
	    флПервая = Истина;
		КонецЕсли;
	КоличествоИзменений = КоличествоИзменений + 1;
	КонецЦикла;
ТЧ.КоличествоИзменений = КоличествоИзменений;
КонецПроцедуры

&НаСервере
Функция ПолучитьГрафикОтгрузки(ЗНП)
ГрафикОтгрузки = "";
	Если ЗНП.Понедельник Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"ПН;";	
	КонецЕсли; 
	Если ЗНП.Вторник Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"ВТ;";	
	КонецЕсли;
	Если ЗНП.Среда Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"СР;";	
	КонецЕсли;
	Если ЗНП.Четверг Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"ЧТ;";	
	КонецЕсли;
	Если ЗНП.Пятница Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"ПТ;";	
	КонецЕсли;
	Если ЗНП.Суббота Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"СБ;";	
	КонецЕсли;
	Если ЗНП.Воскресенье Тогда
	ГрафикОтгрузки = ГрафикОтгрузки+"ВС;";	
	КонецЕсли;
Возврат(ГрафикОтгрузки);
КонецФункции

&НаСервере
Процедура ПолучитьИзмененияНаСервере()
ТаблицаИзменений.Очистить();
Запрос = Новый Запрос;

Запрос.Текст = 
	"ВЫБРАТЬ
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.Период КАК Период,
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ЗНП КАК ЗНП,
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.Товар КАК Товар,
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ДатаОтгрузкиОбещанная КАК ДатаОтгрузкиОбещанная,
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ДатаОтгрузкиНовая КАК ДатаОтгрузкиНовая,
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.Причина КАК Причина
	|ИЗ
	|	РегистрСведений.ИзменениеДатыОтгрузкиОбещанной.СрезПоследних(&НаДату, ) КАК ИзменениеДатыОтгрузкиОбещаннойСрезПоследних
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказНаПроизводство.Заказ КАК ЗаказНаПроизводствоЗаказ
	|		ПО ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ЗНП = ЗаказНаПроизводствоЗаказ.Ссылка
	|			И ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.Товар = ЗаказНаПроизводствоЗаказ.Товар
	|ГДЕ
	|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ДатаОтгрузкиОбещанная МЕЖДУ &ДатаНач И &ДатаКон
	|	И ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ДатаОбработки = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)";
	Если ВидПродукции = 1 Тогда
	Запрос.Текст = Запрос.Текст + " И ТипЗначения(ЗаказНаПроизводствоЗаказ.Продукция) = Тип(Справочник.Номенклатура)";	
	ИначеЕсли ВидПродукции = 2 Тогда	
	Запрос.Текст = Запрос.Текст + " И ТипЗначения(ЗаказНаПроизводствоЗаказ.Продукция) = Тип(Справочник.Материалы)";	
	КонецЕсли; 
Запрос.Текст = Запрос.Текст + " УПОРЯДОЧИТЬ ПО
								|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ЗНП.Контрагент.Наименование,
								|	ИзменениеДатыОтгрузкиОбещаннойСрезПоследних.ЗНП.Номер";
Запрос.УстановитьПараметр("НаДату",ТекущаяДата());
Запрос.УстановитьПараметр("ДатаНач",Период.ДатаНачала);
Запрос.УстановитьПараметр("ДатаКон",Период.ДатаОкончания);
РезультатЗапроса = Запрос.Выполнить();
ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
	ТЧ = ТаблицаИзменений.Добавить();
	ТЧ.Период = ВыборкаДетальныеЗаписи.Период;
	ТЧ.Контрагент = ВыборкаДетальныеЗаписи.ЗНП.Контрагент;
	ТЧ.ЗНП = ВыборкаДетальныеЗаписи.ЗНП;
	ТЧ.Товар = ВыборкаДетальныеЗаписи.Товар;
	ТЧ.Количество = ПолучитьДолг(ВыборкаДетальныеЗаписи.ЗНП,ВыборкаДетальныеЗаписи.Товар);
	ТЧ.ДатаОтгрузкиОбещанная = ВыборкаДетальныеЗаписи.ДатаОтгрузкиОбещанная;
	ТЧ.ДатаОтгрузкиНовая = ВыборкаДетальныеЗаписи.ДатаОтгрузкиНовая;
	ТЧ.Причина = ВыборкаДетальныеЗаписи.Причина;
	ПолучитьДанныеПоИзменениям(ТЧ);
		Если ТЧ.ЗНП.ОтгрузкаПоЗапросу Тогда
		ТЧ.ГрафикОтгрузки = "по запросу";
		Иначе			
		ТЧ.ГрафикОтгрузки = ПолучитьГрафикОтгрузки(ТЧ.ЗНП);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьИзменения(Команда)
ПолучитьИзмененияНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗавершитьОбработкуНаСервере()
	Для каждого ТЧ Из ТаблицаИзменений Цикл
		Если ТЧ.Пометка Тогда
		ИДО = РегистрыСведений.ИзменениеДатыОтгрузкиОбещанной.СоздатьМенеджерЗаписи();
		ИДО.Период = ТЧ.Период;
		ИДО.ЗНП = ТЧ.ЗНП;
		ИДО.Товар = ТЧ.Товар;
		ИДО.ДатаОтгрузкиОбещанная = ТЧ.ДатаОтгрузкиОбещанная;
		ИДО.ДатаОтгрузкиНовая = ТЧ.ДатаОтгрузкиНовая;
		ИДО.Причина = ТЧ.Причина;
		ИДО.ДатаОбработки = ТекущаяДата();
		ИДО.Записать(Истина);
		КонецЕсли; 
	КонецЦикла;
ПолучитьИзмененияНаСервере(); 
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьОбработку(Команда)
ЗавершитьОбработкуНаСервере();
КонецПроцедуры

&НаСервере
Функция ПолучитьСписокКонтрагентов()
СписокКонтрагентов = Новый СписокЗначений;

	Для каждого ТЧ Из ТаблицаИзменений Цикл
		Если СписокКонтрагентов.НайтиПоЗначению(ТЧ.ЗНП.Контрагент) = Неопределено Тогда
		СписокКонтрагентов.Добавить(ТЧ.ЗНП.Контрагент);
		КонецЕсли; 
	КонецЦикла;
Возврат(СписокКонтрагентов);
КонецФункции

&НаСервере
Функция ПечатьКонтрагента(Контрагент)
ТабДок = Новый ТабличныйДокумент;
Результат = Новый Структура("ТД,Пустой",ТабДок,Истина);

ОбъектЗн = РеквизитФормыВЗначение("Объект");
Макет = ОбъектЗн.ПолучитьМакет("Макет");

ОблШапка = Макет.ПолучитьОбласть("Шапка");
ОблТовар = Макет.ПолучитьОбласть("Товар");
ОблКонец = Макет.ПолучитьОбласть("Конец");

ОблШапка.Параметры.Контрагент = Контрагент;
ТабДок.Вывести(ОблШапка);
	Для каждого ТЧ Из ТаблицаИзменений Цикл
		Если ТЧ.Пометка Тогда
			Если ТЧ.ЗНП.Контрагент = Контрагент Тогда
			ОблТовар.Параметры.Счёт = ТЧ.ЗНП.Номер;
			ОблТовар.Параметры.Товар = ТЧ.Товар;
			ОблТовар.Параметры.Количество = ТЧ.Количество;
			ОблТовар.Параметры.ДатаОтгрузки = ТЧ.ДатаОтгрузкиНовая;
			ОблТовар.Параметры.Причина = ТЧ.Причина;
			ТабДок.Вывести(ОблТовар);
			Результат.Пустой = Ложь;
			КонецЕсли;
		КонецЕсли;  
	КонецЦикла;	
ТабДок.Вывести(ОблКонец);
Возврат(Результат);
КонецФункции

&НаКлиенте
Процедура Печать(Команда)
СписокКонтрагентов = ПолучитьСписокКонтрагентов();
	Для каждого Контрагент Из СписокКонтрагентов Цикл
	Результат = ПечатьКонтрагента(Контрагент.Значение);
		Если Не Результат.Пустой Тогда
		Результат.ТД.Показать("Изменения для "+Контрагент.Значение);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ВыбратьВсеНаСервере()
	Для каждого ТЧ Из ТаблицаИзменений Цикл
		Если СписокТоваров.Количество() > 0 Тогда
			Если СписокТоваров.НайтиПоЗначению(ТЧ.Товар) <> Неопределено Тогда
			Продолжить;
			КонецЕсли; 		
		КонецЕсли; 
	ТЧ.Пометка = Истина;
	КонецЦикла; 	
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьВсе(Команда)
ВыбратьВсеНаСервере();	
КонецПроцедуры

&НаКлиенте
Процедура ОтменитьВсе(Команда)
	Для каждого ТЧ Из ТаблицаИзменений Цикл
	ТЧ.Пометка = Ложь;
	КонецЦикла; 
КонецПроцедуры

&НаСервере
Функция ПроверитьВИсключениях(Товар)
	Если СписокТоваров.Количество() > 0 Тогда
		Если СписокТоваров.НайтиПоЗначению(Товар) <> Неопределено Тогда
		Возврат(Ложь);
		КонецЕсли; 		
	КонецЕсли;	
Возврат(Истина);
КонецФункции

&НаКлиенте
Процедура ТаблицаИзмененийПометкаПриИзменении(Элемент)
	Если Элементы.ТаблицаИзменений.ТекущиеДанные.Пометка = Истина Тогда
	Элементы.ТаблицаИзменений.ТекущиеДанные.Пометка = ПроверитьВИсключениях(Элементы.ТаблицаИзменений.ТекущиеДанные.Товар);
	КонецЕсли; 
КонецПроцедуры
